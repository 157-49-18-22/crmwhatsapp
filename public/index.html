<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Client WhatsApp Bot Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .client-section {
            margin-bottom: 30px;
        }

        .client-input {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .client-input input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .client-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-purple {
            background: #6f42c1;
            color: white;
        }

        .btn-purple:hover {
            background: #5a32a3;
        }

        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .client-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .client-id {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .client-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .leads-section {
            margin-bottom: 30px;
        }

        .leads-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leads-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .stage-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stage-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .lead-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .lead-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .lead-details {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .lead-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .message-section {
            margin-bottom: 30px;
        }

        .message-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .tip {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.9em;
            color: #856404;
        }

        .tip i {
            margin-right: 5px;
        }

        .bulk-section {
            margin-top: 30px;
        }

        .bulk-form {
            display: grid;
            gap: 15px;
        }

        .log-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info {
            color: #0c5460;
        }

        .log-success {
            color: #155724;
        }

        .log-error {
            color: #721c24;
        }

        .log-warning {
            color: #856404;
        }

        .no-leads {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn i {
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .clients-grid {
                grid-template-columns: 1fr;
            }
            
            .leads-grid {
                grid-template-columns: 1fr;
            }
            
            .client-input {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Multi-Client WhatsApp Bot Dashboard</h1>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalClients">0</div>
                <div class="stat-label">Total Clients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="connectedClients">0</div>
                <div class="stat-label">Connected</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalMessages">0</div>
                <div class="stat-label">Total Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalLeads">0</div>
                <div class="stat-label">CRM Leads</div>
            </div>
        </div>

        <!-- Client Management -->
        <div class="card client-section">
            <h2>Client Management</h2>
            <div class="client-input">
                <input type="text" id="clientIdInput" placeholder="Enter client ID (e.g., user1, user2)">
                <button class="btn btn-primary" onclick="createClient()">Create New Client</button>
            </div>
            <div id="clientsContainer" class="clients-grid"></div>
        </div>

        <!-- CRM Leads Section -->
        <div class="card leads-section">
            <div class="leads-header">
                <h2>CRM Leads by Stage</h2>
                <button class="btn btn-purple refresh-btn" onclick="refreshCRMData()">
                    <i>🔄</i> Refresh
                </button>
            </div>
            <div id="leadsContainer" class="leads-grid">
                <div class="no-leads">No leads found in CRM. Make sure your CRM backend server is running on port 5000.</div>
            </div>
        </div>

        <!-- Message Sending -->
        <div class="card message-section">
            <h2>Send Message</h2>
            <div class="message-form">
                <div class="form-group">
                    <label for="phoneInput">Phone Number</label>
                    <input type="text" id="phoneInput" placeholder="Enter phone number (e.g., 919354156323)">
                    <div class="tip">
                        <i>💡</i> Tip: Just enter the phone number (e.g., 919354156323). The @c.us suffix will be added automatically.
                    </div>
                </div>
                <div class="form-group">
                    <label for="messageInput">Message</label>
                    <textarea id="messageInput" placeholder="Enter your message"></textarea>
                </div>
                <button class="btn btn-success" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Bulk Message Section -->
        <div class="card bulk-section">
            <h2>Send to Multiple Users</h2>
            <div class="bulk-form">
                <div class="form-group">
                    <label for="bulkMessageInput">Message</label>
                    <textarea id="bulkMessageInput" placeholder="Enter message to send to all connected clients"></textarea>
                </div>
                <button class="btn btn-warning" onclick="sendBulkMessage()">Send to All</button>
            </div>
        </div>

        <!-- Logs -->
        <div class="card">
            <h2>Activity Log</h2>
            <div id="logContainer" class="log-section"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let selectedClientId = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            refreshCRMData();
        });

        // Socket event listeners
        socket.on('connect', () => {
            addLog('Connected to server', 'info');
        });

        socket.on('disconnect', () => {
            addLog('Disconnected from server', 'error');
        });

        socket.on('qr', (data) => {
            addLog(`QR Code received for client ${data.clientId}`, 'info');
        });

        socket.on('ready', (data) => {
            addLog(`Client ${data.clientId} is ready!`, 'success');
            updateStats();
        });

        socket.on('authenticated', (data) => {
            addLog(`Client ${data.clientId} authenticated!`, 'success');
        });

        socket.on('auth_failure', (data) => {
            addLog(`Authentication failed for client ${data.clientId}`, 'error');
        });

        socket.on('disconnected', (data) => {
            addLog(`Client ${data.clientId} disconnected`, 'warning');
            updateStats();
        });

        socket.on('message', (data) => {
            addLog(`New message from ${data.from}: ${data.body}`, 'info');
        });

        socket.on('log', (data) => {
            addLog(data.message, data.type);
        });

        socket.on('crmData', (data) => {
            displayLeads(data.leads, data.pipelines, data.organizedLeads);
        });

        // Functions
        function createClient() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            if (!clientId) {
                addLog('Please enter a client ID', 'error');
                return;
            }
            
            socket.emit('createClient', { clientId: clientId });
            document.getElementById('clientIdInput').value = '';
        }

        function selectClient(clientId) {
            selectedClientId = clientId;
            addLog(`Selected client: ${clientId}`, 'info');
        }

        function sendMessage() {
            if (!selectedClientId) {
                addLog('Please select a client first', 'error');
                return;
            }

            const phone = document.getElementById('phoneInput').value.trim();
            const message = document.getElementById('messageInput').value.trim();

            if (!phone || !message) {
                addLog('Please enter both phone number and message', 'error');
                return;
            }

            socket.emit('sendMessage', {
                clientId: selectedClientId,
                phone: phone,
                message: message
            });

            document.getElementById('phoneInput').value = '';
            document.getElementById('messageInput').value = '';
        }

        function sendBulkMessage() {
            const message = document.getElementById('bulkMessageInput').value.trim();
            if (!message) {
                addLog('Please enter a message', 'error');
                return;
            }

            socket.emit('sendBulkMessage', { message: message });
            document.getElementById('bulkMessageInput').value = '';
        }

        function refreshCRMData() {
            socket.emit('refreshCRMData');
            addLog('Refreshing CRM data...', 'info');
        }

        function displayLeads(leads, pipelines, organizedLeads) {
            const container = document.getElementById('leadsContainer');
            
            if (!leads || leads.length === 0) {
                container.innerHTML = '<div class="no-leads">No leads found in CRM. Make sure your CRM backend server is running on port 5000.</div>';
                document.getElementById('totalLeads').textContent = '0';
                return;
            }

            let html = '';
            
            // Display leads organized by stage
            for (const [stage, stageLeads] of Object.entries(organizedLeads)) {
                html += `
                    <div class="stage-card">
                        <div class="stage-title">${stage} (${stageLeads.length})</div>
                        ${stageLeads.map(lead => `
                            <div class="lead-item">
                                <div class="lead-name">${lead.name || lead.contactName || 'Unknown'}</div>
                                <div class="lead-details">
                                    ${lead.email ? `📧 ${lead.email}<br>` : ''}
                                    ${lead.phone ? `📞 ${lead.phone}<br>` : ''}
                                    ${lead.contactPhone ? `📞 ${lead.contactPhone}<br>` : ''}
                                    ${lead.company ? `🏢 ${lead.company}<br>` : ''}
                                    ${lead.stage ? `📊 Stage: ${lead.stage}` : ''}
                                </div>
                                <div class="lead-actions">
                                    <button class="btn btn-small btn-success" onclick="sendMessageToLead(${lead.id})">
                                        💬 Send Message
                                    </button>
                                    <button class="btn btn-small btn-primary" onclick="viewLeadDetails(${lead.id})">
                                        👁️ View Details
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            container.innerHTML = html;
            document.getElementById('totalLeads').textContent = leads.length;
        }

        function sendMessageToLead(leadId) {
            if (!selectedClientId) {
                addLog('Please select a client first', 'error');
                return;
            }

            const message = prompt('Enter message to send to this lead:');
            if (message) {
                socket.emit('sendMessageToLead', {
                    clientId: selectedClientId,
                    leadId: leadId,
                    message: message
                });
            }
        }

        function viewLeadDetails(leadId) {
            addLog(`Viewing details for lead ID: ${leadId}`, 'info');
            // You can implement a modal or detailed view here
        }

        function updateStats() {
            fetch('/api/clients')
                .then(response => response.json())
                .then(clients => {
                    const connected = clients.filter(c => c.status === 'connected').length;
                    const totalMessages = clients.reduce((sum, c) => sum + c.messageCount, 0);
                    
                    document.getElementById('totalClients').textContent = clients.length;
                    document.getElementById('connectedClients').textContent = connected;
                    document.getElementById('totalMessages').textContent = totalMessages;
                    
                    displayClients(clients);
                })
                .catch(error => {
                    console.error('Error fetching clients:', error);
                });
        }

        function displayClients(clients) {
            const container = document.getElementById('clientsContainer');
            
            if (clients.length === 0) {
                container.innerHTML = '<div class="no-leads">No clients created yet. Create your first client above!</div>';
                return;
            }

            const html = clients.map(client => `
                <div class="client-card">
                    <div class="client-header">
                        <div class="client-id">${client.clientId}</div>
                        <span class="status-badge status-${client.status}">${client.status}</span>
                    </div>
                    <div>Messages: ${client.messageCount}</div>
                    <div class="client-actions">
                        <button class="btn btn-small btn-primary" onclick="selectClient('${client.clientId}')">
                            Select
                        </button>
                        <button class="btn btn-small btn-warning" onclick="restartClient('${client.clientId}')">
                            Restart
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteClient('${client.clientId}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function restartClient(clientId) {
            socket.emit('restartClient', { clientId: clientId });
        }

        function deleteClient(clientId) {
            if (confirm(`Are you sure you want to delete client ${clientId}?`)) {
                socket.emit('deleteClient', { clientId: clientId });
            }
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        // Auto-refresh stats every 5 seconds
        setInterval(updateStats, 5000);
    </script>
</body>
</html> 