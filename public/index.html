<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .whatsapp-container {
            display: flex;
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            background: linear-gradient(135deg, #008069 0%, #25d366 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 500;
        }

        .stats-section {
            padding: 16px;
            background: #f0f2f5;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #008069, #25d366);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #008069, #25d366);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #667781;
            font-size: 12px;
        }

        .client-section {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .client-input {
            margin-bottom: 16px;
        }

        .client-input input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e9edef;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        /* Messaging Section in Sidebar */
        .messaging-section {
            background: white;
            border-radius: 8px;
            margin: 16px;
            border: 1px solid #e9edef;
            overflow: hidden;
        }

        .messaging-header {
            background: #f0f2f5;
            padding: 12px 16px;
            border-bottom: 1px solid #e9edef;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .messaging-content {
            padding: 16px;
        }

        .message-tabs {
            display: flex;
            margin-bottom: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 2px;
        }

        .message-tab {
            flex: 1;
            padding: 6px 10px;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: #667781;
        }

        .message-tab.active {
            background: #008069;
            color: white;
        }

        .message-tab:hover:not(.active) {
            background: #e9ecef;
        }

        .message-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .phone-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e9edef;
            border-radius: 6px;
            font-size: 12px;
        }

        .message-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e9edef;
            border-radius: 6px;
            font-size: 12px;
            resize: none;
            min-height: 60px;
            max-height: 100px;
        }

        .send-btn {
            background: #008069;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            align-self: flex-end;
        }

        .send-btn:hover {
            background: #006d5b;
        }

        .message-tip {
            font-size: 10px;
            color: #667781;
            margin-top: 4px;
            font-style: italic;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #008069;
            color: white;
        }

        .btn-primary:hover {
            background: #006d5b;
        }

        .btn-success {
            background: #25d366;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .client-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #25d366;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .client-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #25d366, #128c7e);
        }

        .client-card:hover {
            transform: translateX(5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .client-id {
            font-weight: 600;
            color: #111b21;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-connected {
            background: #d4edda;
            color: #155724;
        }

        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }

        .client-actions {
            display: flex;
            gap: 6px;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
        }

        /* Main Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            position: relative;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            background: linear-gradient(135deg, #008069, #25d366);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header h2 {
            font-size: 16px;
            font-weight: 500;
        }

        .chat-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px;
        }

        .message-bubble {
            max-width: 65%;
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
        }

        .message-outgoing {
            background: #d9fdd3;
            margin-left: auto;
            border-bottom-right-radius: 2px;
        }

        .message-incoming {
            background: white;
            margin-right: auto;
            border-bottom-left-radius: 2px;
        }

        .message-time {
            font-size: 11px;
            color: #667781;
            margin-top: 4px;
            text-align: right;
        }

        /* Message Input Area */
        .message-input-area {
            background: #f0f2f5;
            padding: 16px;
            border-top: 1px solid #e9edef;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
        }

        /* CRM Section - Now integrated into main layout */
        .crm-section {
            width: 280px;
            background: white;
            border-left: 1px solid #e9edef;
            display: flex;
            flex-direction: column;
        }

        .crm-header {
            background: #f0f2f5;
            padding: 12px 16px;
            border-bottom: 1px solid #e9edef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .crm-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .leads-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .lead-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border-left: 3px solid #25d366;
            transition: all 0.2s;
        }

        .lead-card:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .lead-name {
            font-weight: 600;
            color: #111b21;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .lead-stage {
            color: #667781;
            font-size: 11px;
        }

        /* Logs Section - Now integrated into sidebar */
        .log-section {
            background: white;
            border-radius: 8px;
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e9edef;
        }

        .log-header {
            background: #f0f2f5;
            padding: 12px 16px;
            border-bottom: 1px solid #e9edef;
            font-weight: 600;
            font-size: 13px;
        }

        .log-content {
            padding: 12px 16px;
        }

        .log-entry {
            padding: 4px 0;
            font-size: 11px;
            border-bottom: 1px solid #f0f2f5;
            line-height: 1.4;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-info { color: #008069; }
        .log-success { color: #25d366; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }

        /* Responsive */
        @media (max-width: 1200px) {
            .crm-section {
                width: 250px;
            }
        }

        @media (max-width: 768px) {
            .whatsapp-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
            }
            
            .chat-area {
                height: 60%;
            }
            
            .crm-section {
                width: 100%;
                height: 200px;
                border-left: none;
                border-top: 1px solid #e9edef;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        @keyframes spin360 {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spin {
            animation: spin360 0.7s linear;
        }
        .message-menu-option {
            padding: 10px 16px;
            cursor: pointer;
            color: #222;
            transition: background 0.2s, transform 0.18s;
        }
        .message-menu-option:hover {
            background: #f0f2f5;
            transform: scale(1.07);
        }
        .message-menu-separator {
            height: 1px;
            background: #e0e0e0;
            margin: 0 8px;
        }
        .modal-container {
            background: linear-gradient(135deg, #f8fff8 0%, #f0f7ff 100%);
            border-radius: 18px;
            padding: 40px 32px 30px 32px;
            min-width: 340px;
            max-width: 96vw;
            box-shadow: 0 8px 32px #25d36622, 0 2px 16px #00806911;
            border-top: 5px solid #25d366;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            animation: modalPopIn 0.32s cubic-bezier(.23,1.12,.62,1.01);
        }
        @keyframes modalPopIn {
            0% { transform: scale(0.92) translateY(40px); opacity: 0; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
        .modal-close-btn {
            position: absolute;
            top: 18px;
            right: 22px;
            background: #f0f2f5;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            font-size: 22px;
            color: #333;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .modal-close-btn:hover {
            background: #ffeaea;
            color: #dc3545;
        }
        .modal-title {
            font-size: 1.5rem;
            font-family: 'Segoe UI Semibold', 'Segoe UI', Arial, sans-serif;
            font-weight: 700;
            margin-bottom: 22px;
            color: #008069;
            letter-spacing: 0.5px;
            text-align: center;
        }
        .modal-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 10px;
        }
        .modal-form input,
        .modal-form textarea {
            border: 1.5px solid #e0e0e0;
            border-radius: 9px;
            padding: 12px 16px;
            font-size: 1rem;
            outline: none;
            background: #fafdff;
            transition: border 0.2s, box-shadow 0.2s;
        }
        .modal-form input:focus,
        .modal-form textarea:focus {
            border: 1.5px solid #25d366;
            box-shadow: 0 0 0 2px #25d36622;
        }
        .modal-send-btn {
            background: linear-gradient(90deg, #25d366 60%, #008069 100%);
            color: #fff;
            border: none;
            border-radius: 9px;
            padding: 13px 0;
            font-size: 1.08rem;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.18s, transform 0.18s, box-shadow 0.18s;
            margin-top: 4px;
            box-shadow: 0 2px 8px #25d36622;
        }
        .modal-send-btn:hover {
            background: linear-gradient(90deg, #20b95a 60%, #008069 100%);
            transform: scale(1.06);
            box-shadow: 0 4px 16px #25d36633;
        }
        .modal-divider {
            width: 100%;
            height: 1px;
            background: #e0e0e0;
            margin: 18px 0 8px 0;
        }
        .modal-tip {
            font-size: 12px;
            color: #667781;
            margin-top: 8px;
            text-align: center;
            font-style: italic;
        }
        @media (max-width: 600px) {
            .modal-container {
                min-width: 0;
                width: 98vw;
                padding: 18px 4vw 18px 4vw;
            }
        }
        .bulk-dropdown-container {
            position: relative;
            width: 100%;
        }
        .bulk-dropdown-textarea-wrap {
            position: relative;
            width: 100%;
        }
        .bulk-dropdown-btn {
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            z-index: 2;
            display: flex;
            align-items: center;
        }
        .bulk-dropdown-list {
            position: absolute;
            top: 48px;
            right: 0;
            left: 0;
            background: #fff;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 16px #25d36622;
            max-height: 180px;
            overflow-y: auto;
            z-index: 10;
        }
        .bulk-dropdown-item {
            padding: 8px 16px;
            cursor: pointer;
            transition: background 0.18s;
        }
        .bulk-dropdown-item:hover {
            background: #f0f2f5;
        }
        .bulk-dropdown-selected {
            background: #eaffea;
        }
    </style>
</head>
<body>
    <div class="whatsapp-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><img src="chat1.png" alt="WhatsApp" style="height:22px;width:22px;vertical-align:middle;margin-right:6px;">WhatsApp Bot</h1>
            </div>
            
            <div class="stats-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalClients">0</div>
                        <div class="stat-label">Clients</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="connectedClients">0</div>
                        <div class="stat-label">Connected</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalMessages">0</div>
                        <div class="stat-label">Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalLeads">0</div>
                        <div class="stat-label">Leads</div>
                    </div>
                </div>
            </div>
            
            <div class="client-section">
                <div class="client-input">
                    <input type="text" id="clientIdInput" placeholder="Enter client ID (e.g., user1)">
                    <button class="btn btn-primary" onclick="createClient()">Create Client</button>
                </div>
                <div id="clientsContainer"></div>
                
                <!-- Logs Section integrated into sidebar -->
                <div class="log-section">
                    <div class="log-header" style="display:flex;align-items:center;justify-content:space-between;">
                        <span><img src="log.png" alt="Log" style="height:18px;vertical-align:middle;margin-right:6px;"> Activity Log</span>
                        <img id="activitySyncIcon" src="sync.png" alt="Sync" style="height:18px;vertical-align:middle;cursor:pointer;" onclick="spinAndRefresh()">
                    </div>
                    <div class="log-content" id="logContainer"></div>
                </div>
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-area">
            <div class="chat-header">
                <h2><img src="crm.png" alt="WhatsApp" style="height:22px;width:22px;vertical-align:middle;margin-right:6px;">CRM Leads</h2>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="position: relative;">
                        <button id="leadsMenuBtn" style="background: none; border: none; font-size: 22px; cursor: pointer; padding:0 4px;">
                            <img src="dots.png" alt="Menu" style="height:22px;width:22px;vertical-align:middle;">
                        </button>
                        <div id="leadsMenuDropdown" style="display: none; position: absolute; right: 0; top: 28px; background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; box-shadow: 0 2px 8px #0002; min-width: 120px; z-index: 1000;">
                            <div class="message-menu-option" onclick="openMessageModal('single')">Single Message</div>
                            <div class="message-menu-separator"></div>
                            <div class="message-menu-option" onclick="openMessageModal('bulk')">Bulk Message</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-content" id="chatContent">
                <div id="leadsContainer">
                    <div style="text-align: center; color: #667781; font-size: 14px; padding: 40px;">Loading leads...</div>
                </div>
            </div>
        </div>

        <!-- CRM Section - Now part of main layout -->
        <div class="crm-section">
            <div class="crm-header">
                <h2>💬 Bot Dashboard</h2>
            </div>
            <div class="crm-content">
                <div id="botChatContent">
                    <div class="message-bubble message-incoming">
                        <div>Welcome to WhatsApp Bot Dashboard! 👋</div>
                        <div class="message-time">Just now</div>
                    </div>
                    
                    <div class="message-bubble message-incoming">
                        <div>Select a client and start managing your WhatsApp connections.</div>
                        <div class="message-time">Just now</div>
                    </div>
                </div>
                
                <!-- Messaging Section -->
                <!-- Removed from here: .messaging-section -->
            </div>
        </div>
    </div>

    <div id="messageModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); z-index:2000; align-items:center; justify-content:center;">
        <div class="modal-container">
            <button class="modal-close-btn" onclick="closeMessageModal()">✖</button>
            <div id="modalSingleForm" style="display:none; width:100%;">
                <div class="modal-title">Send Single Message</div>
                <form class="modal-form" onsubmit="event.preventDefault(); sendModalSingleMessage();">
                    <input type="text" id="modalSinglePhoneInput" placeholder="Enter phone number (e.g., 919354156323)">
                    <textarea id="modalSingleMessageInput" placeholder="Type a message..." rows="3"></textarea>
                    <button type="submit" class="modal-send-btn"><img src="send.png" alt="Send" style="height:18px;vertical-align:middle;margin-right:6px;">Send</button>
                </form>
                <div class="modal-divider"></div>
                <div class="modal-tip">Tip: Use WhatsApp web to get the correct phone number format.</div>
            </div>
            <div id="modalBulkForm" style="display:none; width:100%;">
                <div class="modal-title">Send Bulk Message</div>
                <form class="modal-form" onsubmit="event.preventDefault(); sendModalBulkMessage();">
                    <div class="bulk-dropdown-container">
                        <div class="bulk-dropdown-textarea-wrap">
                            <textarea id="modalBulkMessageInput" placeholder="Enter phone numbers (one per line)..." rows="3" style="padding-right:38px;width:100%;box-sizing:border-box;"></textarea>
                            <button type="button" class="bulk-dropdown-btn" tabindex="-1" onclick="toggleBulkDropdown()" style="height:32px;width:32px;">
                                <img src="down-arrow.png" alt="Dropdown" style="height:17px;width:17px;vertical-align:middle;margin-bottom: 37px;margin-left: 17px;">
                            </button>
                            <div id="bulkDropdownList" class="bulk-dropdown-list" style="display:none;"></div>
                        </div>
                    </div>
                    <textarea id="modalBulkMessageContent" placeholder="Type a message..." rows="3"></textarea>
                    <button type="submit" class="modal-send-btn"><img src="send.png" alt="Send" style="height:18px;vertical-align:middle;margin-right:6px;">Send Bulk</button>
                </form>
                <div class="modal-divider"></div>
                <div class="modal-tip">Tip: Use WhatsApp web to get the correct phone number format.</div>
            </div>
        </div>
    </div>

    <script>
        // Make spinAndRefresh globally available
        function spinAndRefresh() {
            var icon = document.getElementById('activitySyncIcon');
            icon.classList.remove('spin');
            // Force reflow to restart animation
            void icon.offsetWidth;
            icon.classList.add('spin');
            refreshCRMData();
            // Remove the class after animation so it can be triggered again
            icon.addEventListener('animationend', function handler() {
                icon.classList.remove('spin');
                icon.removeEventListener('animationend', handler);
            });
        }
        const socket = io();
        let selectedClientId = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            refreshCRMData();
            addMessage('System', 'Dashboard loaded successfully!', 'incoming');

            // 3-dots menu logic (moved here)
            document.getElementById('leadsMenuBtn').onclick = function(e) {
                e.stopPropagation();
                const menu = document.getElementById('leadsMenuDropdown');
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            };
            document.body.addEventListener('click', function() {
                document.getElementById('leadsMenuDropdown').style.display = 'none';
            });
            document.getElementById('leadsMenuDropdown').onclick = function(e) {
                e.stopPropagation();
            };
            // Modal textarea auto-resize and enter-to-send
            document.getElementById('modalSingleMessageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            document.getElementById('modalBulkMessageInput').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            document.getElementById('modalBulkMessageContent').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            document.getElementById('modalSingleMessageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendModalSingleMessage();
                }
            });
            document.getElementById('modalBulkMessageContent').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendModalBulkMessage();
                }
            });
        });

        // Socket event listeners
        socket.on('connect', () => {
            addLog('Connected to server', 'success');
            addMessage('System', 'Connected to WhatsApp Bot server', 'incoming');
        });

        socket.on('disconnect', () => {
            addLog('Disconnected from server', 'error');
            addMessage('System', 'Disconnected from server', 'incoming');
        });

        socket.on('qr', (data) => {
            addLog(`QR Code received for client ${data.clientId}`, 'info');
            addMessage('System', `QR Code ready for client ${data.clientId}`, 'incoming');
        });

        socket.on('botStatus', (data) => {
            addLog(`Bot status update for client ${data.clientId}: ${data.status}`, 'info');
            addMessage('System', `Client ${data.clientId}: ${data.status}`, 'incoming');
            updateStats();
        });

        socket.on('ready', (data) => {
            addLog(`Client ${data.clientId} is ready!`, 'success');
            addMessage('System', `✅ Client ${data.clientId} connected!`, 'incoming');
            updateStats();
        });

        socket.on('authenticated', (data) => {
            addLog(`Client ${data.clientId} authenticated!`, 'success');
            addMessage('System', `🔐 Client ${data.clientId} authenticated`, 'incoming');
        });

        socket.on('auth_failure', (data) => {
            addLog(`Authentication failed for client ${data.clientId}`, 'error');
            addMessage('System', `❌ Auth failed for client ${data.clientId}`, 'incoming');
        });

        socket.on('disconnected', (data) => {
            addLog(`Client ${data.clientId} disconnected`, 'warning');
            addMessage('System', `🔌 Client ${data.clientId} disconnected`, 'incoming');
            updateStats();
        });

        socket.on('message', (data) => {
            addLog(`New message from ${data.from}: ${data.body}`, 'info');
            addMessage(data.from, data.body, 'incoming');
        });

        socket.on('log', (data) => {
            addLog(data.message, data.type);
        });

        socket.on('crmData', (data) => {
            displayLeads(data.leads, data.pipelines, data.organizedLeads);
        });

        // Functions
        function showMessageForm(type) {
            // Update tab styling
            document.querySelectorAll('.message-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show/hide forms
            if (type === 'single') {
                document.getElementById('singleMessageForm').style.display = 'flex';
                document.getElementById('bulkMessageForm').style.display = 'none';
            } else {
                document.getElementById('singleMessageForm').style.display = 'none';
                document.getElementById('bulkMessageForm').style.display = 'flex';
            }
        }

        function createClient() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            if (!clientId) {
                addLog('Please enter a client ID', 'error');
                return;
            }
            
            socket.emit('createClient', { clientId: clientId });
            document.getElementById('clientIdInput').value = '';
            addMessage('System', `Creating client: ${clientId}`, 'incoming');
        }

        function selectClient(clientId) {
            selectedClientId = clientId;
            addLog(`Selected client: ${clientId}`, 'info');
            addMessage('System', `Selected client: ${clientId}`, 'incoming');
        }

        function sendSingleMessage() {
            if (!selectedClientId) {
                addLog('Please select a client first', 'error');
                addMessage('System', 'Please select a client first', 'incoming');
                return;
            }

            const phone = document.getElementById('singlePhoneInput').value.trim();
            const message = document.getElementById('singleMessageInput').value.trim();
            
            if (!phone || !message) {
                addLog('Please enter both phone number and message', 'error');
                addMessage('System', 'Please enter both phone number and message', 'incoming');
                return;
            }

            addMessage('You', `To ${phone}: ${message}`, 'outgoing');
            socket.emit('sendMessage', {
                clientId: selectedClientId,
                to: phone,
                message: message
            });

            document.getElementById('singlePhoneInput').value = '';
            document.getElementById('singleMessageInput').value = '';
        }

        function sendBulkMessage() {
            if (!selectedClientId) {
                addLog('Please select a client first', 'error');
                addMessage('System', 'Please select a client first', 'incoming');
                return;
            }

            const phoneNumbers = document.getElementById('bulkMessageInput').value.trim();
            const message = document.getElementById('bulkMessageContent').value.trim();
            
            if (!phoneNumbers || !message) {
                addLog('Please enter both phone numbers and message', 'error');
                addMessage('System', 'Please enter both phone numbers and message', 'incoming');
                return;
            }

            const phones = phoneNumbers.split('\n').filter(phone => phone.trim() !== '');
            
            if (phones.length === 0) {
                addLog('Please enter at least one phone number', 'error');
                addMessage('System', 'Please enter at least one phone number', 'incoming');
                return;
            }

            addMessage('You', `Bulk message to ${phones.length} numbers: ${message}`, 'outgoing');
            
            // Send to each phone number
            phones.forEach(phone => {
                socket.emit('sendMessage', {
                    clientId: selectedClientId,
                    to: phone.trim(),
                    message: message
                });
            });

            document.getElementById('bulkMessageInput').value = '';
            document.getElementById('bulkMessageContent').value = '';
        }

        function refreshCRMData() {
            socket.emit('refreshCRMData');
            addLog('Refreshing CRM data...', 'info');
        }

        // Store leads globally for message sending
        window._allLeads = [];

        function displayLeads(leads, pipelines, organizedLeads) {
            window._allLeads = leads; // Store for later use
            const container = document.getElementById('leadsContainer');
            
            if (!leads || leads.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #667781; font-size: 14px; padding: 40px;">No leads found</div>';
                document.getElementById('totalLeads').textContent = '0';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 16px;">';
            
            for (const [stage, stageLeads] of Object.entries(organizedLeads)) {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #25d366; position: relative;">
                        <div class="message-icon" data-stage="${stage}" style="position: absolute; top: 12px; right: 12px; width: 20px; height: 20px; opacity: 0.7; cursor: pointer;">💬</div>
                        <div style="font-weight: 600; color: #111b21; margin-bottom: 8px; font-size: 16px;">${stage}</div>
                        <div style="font-size: 24px; font-weight: bold; color: #008069; margin-bottom: 4px;">${stageLeads.length}</div>
                        <div style="color: #667781; font-size: 12px;">leads</div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
            document.getElementById('totalLeads').textContent = leads.length;

            // Add click event listeners to message icons
            document.querySelectorAll('.message-icon').forEach(icon => {
                icon.addEventListener('click', function(e) {
                    showMessageInputBox(this.getAttribute('data-stage'));
                });
            });
        }

        // Add the message input box HTML to the body (hidden by default)
        if (!document.getElementById('customMessageInputBox')) {
            const msgBox = document.createElement('div');
            msgBox.id = 'customMessageInputBox';
            msgBox.style.display = 'none';
            msgBox.innerHTML = `
                <div style="position:fixed;left:0;right:0;bottom:0;z-index:9999;background:#fff;border-top:2px solid #25d366;box-shadow:0 -2px 16px #0002;padding:16px 24px;display:flex;align-items:center;gap:12px;">
                    <input id="customMsgInput" type="text" placeholder="Write something..." style="flex:1;padding:10px 14px;border:1px solid #e0e0e0;border-radius:6px;font-size:1rem;" />
                    <input id="customFileInput" type="file" style="display:none;" />
                    <button id="customFileBtn" style="background:#25d366;color:#fff;border:none;border-radius:6px;padding:8px 14px;font-size:1rem;cursor:pointer;"><img src="attach.png" alt="Attach" style="height:18px;vertical-align:middle;margin-right:6px;"></button>
                    <button id="customMsgSendBtn" style="background:#008069;color:#fff;border:none;border-radius:6px;padding:8px 18px;font-size:1rem;cursor:pointer;">Send</button>
                    <button id="customMsgCloseBtn" style="background:#eee;color:#333;border:none;border-radius:6px;padding:8px 14px;font-size:1rem;cursor:pointer;">✖</button>
                </div>
            `;
            document.body.appendChild(msgBox);
        }

        function showMessageInputBox(stage) {
            const box = document.getElementById('customMessageInputBox');
            box.style.display = 'block';
            box.setAttribute('data-stage', stage);
        }
        // Hide box on close
        document.getElementById('customMsgCloseBtn').onclick = function() {
            document.getElementById('customMessageInputBox').style.display = 'none';
        };
        // File button opens file input
        document.getElementById('customFileBtn').onclick = function() {
            document.getElementById('customFileInput').click();
        };
        // Optional: handle file selection (show file name, etc.)
        document.getElementById('customFileInput').onchange = function(e) {
            if (e.target.files.length > 0) {
                document.getElementById('customFileBtn').textContent = '📎 ' + e.target.files[0].name;
            } else {
                document.getElementById('customFileBtn').textContent = '📎';
            }
        };
        // Send button (implement your logic here)
        document.getElementById('customMsgSendBtn').onclick = function() {
            const msg = document.getElementById('customMsgInput').value;
            const file = document.getElementById('customFileInput').files[0];
            const stage = document.getElementById('customMessageInputBox').getAttribute('data-stage');
            if (!msg) {
                alert('Please enter a message.');
                return;
            }
            // Get all phone numbers for leads in this stage
            const leads = window._allLeads || [];
            const numbers = leads.filter(l => l.stage === stage && l.contact_phone && l.contact_phone.trim() !== '').map(l => l.contact_phone.trim());
            if (numbers.length === 0) {
                alert('No phone numbers found for this stage.');
                return;
            }
            // Send message to each number
            if (!file) {
                numbers.forEach(phone => {
                    socket.emit('sendMessage', {
                        clientId: selectedClientId,
                        to: phone,
                        message: msg
                    });
                });
                alert('Message sent to ' + numbers.length + ' numbers.');
            } else {
                // TODO: Implement file sending logic if needed
                alert('File sending to multiple numbers is not implemented.');
            }
            document.getElementById('customMessageInputBox').style.display = 'none';
            document.getElementById('customMsgInput').value = '';
            document.getElementById('customFileInput').value = '';
            document.getElementById('customFileBtn').textContent = '📎';
        };

        function updateStats() {
            fetch('/api/clients')
                .then(response => response.json())
                .then(clients => {
                    const connected = clients.filter(c => c.status === 'connected').length;
                    const totalMessages = clients.reduce((sum, c) => sum + c.messageCount, 0);
                    
                    document.getElementById('totalClients').textContent = clients.length;
                    document.getElementById('connectedClients').textContent = connected;
                    document.getElementById('totalMessages').textContent = totalMessages;
                    
                    displayClients(clients);
                })
                .catch(error => {
                    console.error('Error fetching clients:', error);
                });
        }

        function displayClients(clients) {
            const container = document.getElementById('clientsContainer');
            
            if (clients.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #667781; font-size: 12px;">No clients created yet</div>';
                return;
            }

            const html = clients.map(client => `
                <div class="client-card">
                    <div class="client-header">
                        <div class="client-id">${client.clientId}</div>
                        <span class="status-badge status-${client.status}">${client.status}</span>
                    </div>
                    <div style="font-size: 12px; color: #667781; margin-bottom: 8px;">Messages: ${client.messageCount}</div>
                    <div class="client-actions">
                        <button class="btn btn-small btn-primary" onclick="selectClient('${client.clientId}')">Select</button>
                        <button class="btn btn-small btn-warning" onclick="restartClient('${client.clientId}')">Restart</button>
                        <button class="btn btn-small btn-danger" onclick="deleteClient('${client.clientId}')">Delete</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function restartClient(clientId) {
            socket.emit('restartClient', { clientId: clientId });
            addMessage('System', `Restarting client: ${clientId}`, 'incoming');
        }

        function deleteClient(clientId) {
            if (confirm(`Delete client ${clientId}?`)) {
                socket.emit('deleteClient', { clientId: clientId });
                addMessage('System', `Deleting client: ${clientId}`, 'incoming');
            }
        }

        function addMessage(sender, text, type) {
            const container = document.getElementById('botChatContent'); // Changed to botChatContent
            const timestamp = new Date().toLocaleTimeString();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message-bubble message-${type}`;
            messageDiv.innerHTML = `
                <div><strong>${sender}:</strong> ${text}</div>
                <div class="message-time">${timestamp}</div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addLog(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
        }

        // Auto-resize textarea
        document.getElementById('singleMessageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        document.getElementById('bulkMessageInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        document.getElementById('bulkMessageContent').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send message on Enter
        document.getElementById('singleMessageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendSingleMessage();
            }
        });

        document.getElementById('bulkMessageContent').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBulkMessage();
            }
        });

        // Auto-refresh stats every 5 seconds
        setInterval(updateStats, 5000);

        // Modal logic
        function openMessageModal(type) {
            document.getElementById('messageModal').style.display = 'flex';
            document.getElementById('modalSingleForm').style.display = type === 'single' ? 'block' : 'none';
            document.getElementById('modalBulkForm').style.display = type === 'bulk' ? 'block' : 'none';
        }
        function closeMessageModal() {
            document.getElementById('messageModal').style.display = 'none';
            document.getElementById('modalSinglePhoneInput').value = '';
            document.getElementById('modalSingleMessageInput').value = '';
            document.getElementById('modalBulkMessageInput').value = '';
            document.getElementById('modalBulkMessageContent').value = '';
        }
        // Modal send logic
        function sendModalSingleMessage() {
            if (!selectedClientId) {
                addLog('Please select a client first', 'error');
                addMessage('System', 'Please select a client first', 'incoming');
                return;
            }
            const phone = document.getElementById('modalSinglePhoneInput').value.trim();
            const message = document.getElementById('modalSingleMessageInput').value.trim();
            if (!phone || !message) {
                addLog('Please enter both phone number and message', 'error');
                addMessage('System', 'Please enter both phone number and message', 'incoming');
                return;
            }
            addMessage('You', `To ${phone}: ${message}`, 'outgoing');
            socket.emit('sendMessage', {
                clientId: selectedClientId,
                to: phone,
                message: message
            });
            closeMessageModal();
        }
        function sendModalBulkMessage() {
            if (!selectedClientId) {
                addLog('Please select a client first', 'error');
                addMessage('System', 'Please select a client first', 'incoming');
                return;
            }
            const phoneNumbers = document.getElementById('modalBulkMessageInput').value.trim();
            const message = document.getElementById('modalBulkMessageContent').value.trim();
            if (!phoneNumbers || !message) {
                addLog('Please enter both phone numbers and message', 'error');
                addMessage('System', 'Please enter both phone numbers and message', 'incoming');
                return;
            }
            const phones = phoneNumbers.split('\n').filter(phone => phone.trim() !== '');
            if (phones.length === 0) {
                addLog('Please enter at least one phone number', 'error');
                addMessage('System', 'Please enter at least one phone number', 'incoming');
                return;
            }
            addMessage('You', `Bulk message to ${phones.length} numbers: ${message}`, 'outgoing');
            phones.forEach(phone => {
                socket.emit('sendMessage', {
                    clientId: selectedClientId,
                    to: phone.trim(),
                    message: message
                });
            });
            closeMessageModal();
        }
    // Dropdown for bulk phone numbers
    function toggleBulkDropdown() {
        const dropdown = document.getElementById('bulkDropdownList');
        if (dropdown.style.display === 'block') {
            dropdown.style.display = 'none';
            return;
        }
        // Populate dropdown
        const leads = window._allLeads || [];
        const numbers = Array.from(new Set(leads.map(l => l.contact_phone).filter(n => n && n.trim() !== '')));
        dropdown.innerHTML = numbers.length ? numbers.map(num => `<div class='bulk-dropdown-item' onclick='selectBulkNumber("${num}")'>${num}</div>`).join('') : '<div style="padding:10px 16px;color:#888;">No numbers found</div>';
        dropdown.style.display = 'block';
        // Hide on outside click
        setTimeout(() => {
            document.addEventListener('mousedown', closeBulkDropdown, { once: true });
        }, 0);
    }
    function closeBulkDropdown(e) {
        const dropdown = document.getElementById('bulkDropdownList');
        if (!dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    }
    function selectBulkNumber(num) {
        const textarea = document.getElementById('modalBulkMessageInput');
        let lines = textarea.value.split('\n').map(l => l.trim()).filter(l => l);
        if (!lines.includes(num)) lines.push(num);
        textarea.value = lines.join('\n');
        document.getElementById('bulkDropdownList').style.display = 'none';
        textarea.focus();
    }
    // Hide dropdown if modal closes
    function closeMessageModal() {
        document.getElementById('messageModal').style.display = 'none';
        document.getElementById('modalSinglePhoneInput').value = '';
        document.getElementById('modalSingleMessageInput').value = '';
        document.getElementById('modalBulkMessageInput').value = '';
        document.getElementById('modalBulkMessageContent').value = '';
        document.getElementById('bulkDropdownList').style.display = 'none';
    }
    </script>
</body>
</html> 